(function(){"use strict";const P=(o,r,e)=>{if(r==="custom"){const n=Object.values(e);if(n.length===0)return[];if(o===1){const l=Math.min(...n.map(t=>t.y));return Object.keys(e).filter(t=>e[t].y===l)}else{const l=Math.max(...n.map(t=>t.y));return Object.keys(e).filter(t=>e[t].y===l)}}return o===1?["1","2","3"]:o===2?r==="square"?["6","7","8"]:["16","17","18"]:[]},E=(o,r,e,n,l)=>{const t=[],s=o.node,f=e[s];if(!f)return[];const g=y=>r.find(u=>String(u.node)===String(y));return Array.from(n[s]||[]).forEach(y=>{const u=g(y);if(u){if(u.player!==o.player){const i=e[y];Array.from(n[y]||[]).forEach(c=>{if(String(c)===String(s)||g(c))return;const j=e[c];if(!j)return;const p={x:i.x-f.x,y:i.y-f.y},S={x:j.x-i.x,y:j.y-i.y},K=Math.sqrt(p.x*p.x+p.y*p.y),v=Math.sqrt(S.x*S.x+S.y*S.y);if(K===0||v===0)return;if((p.x*S.x+p.y*S.y)/(K*v)>.9){let I=!1;(o.isKing||l==="custom"||o.player===1&&p.y<0||o.player===2&&p.y>0||Math.abs(p.y)<.1)&&(I=!0),I&&t.push({target:c,type:"jump",captured:u.id})}})}}else{const i=e[y];if(!i)return;let m=!1;(o.isKing||l==="custom"||o.player===1&&i.y<f.y||o.player===2&&i.y>f.y||i.y===f.y)&&(m=!0),m&&t.push({target:y,type:"walk"})}}),t},h=(o,r,e,n)=>{const l=o.map(s=>({...s})),t=l.find(s=>s.id===r.pieceId);if(!t)return l;if(t.node=r.target,t.isKing||P(t.player,n,e).includes(String(r.target))&&(t.isKing=!0),r.type==="jump"&&r.captured){const s=l.findIndex(f=>f.id===r.captured);s!==-1&&l.splice(s,1)}return l},V=(o,r)=>{let e=0;return o.forEach(n=>{let l=n.isKing?100:20;const t=r[n.node];t&&(n.player===2&&!n.isKing?l+=t.y*2:n.player===1&&n.isKing,t.x>=3&&t.x<=5&&(l+=3)),n.player===2?e+=l:e-=l}),e},k=(o,r,e,n,l)=>{const t=r.filter(g=>g.player===o);let s=[];t.forEach(g=>{E(g,r,e,n,l).forEach(y=>s.push({...y,pieceId:g.id}))});const f=s.filter(g=>g.type==="jump");return f.length>0?f:s},x=(o,r,e,n,l,t,s,f)=>{if(r===0)return V(o,t);const M=k(l?2:1,o,t,s,f);if(M.length===0)return l?-1e4:1e4;if(M.sort((y,u)=>y.type==="jump"&&u.type!=="jump"?-1:u.type==="jump"&&y.type!=="jump"?1:0),l){let y=-1/0;for(const u of M){const i=h(o,u,t,f);let m;if(u.type==="jump"){const c=i.find(p=>p.id===u.pieceId),j=P(c.player,f,t);c&&!c.isKing&&j.includes(String(u.target))?m=x(i,r-1,e,n,!1,t,s,f):c&&E(c,i,t,s,f).filter(K=>K.type==="jump").length>0?m=x(i,r,e,n,!0,t,s,f):m=x(i,r-1,e,n,!1,t,s,f)}else m=x(i,r-1,e,n,!1,t,s,f);if(y=Math.max(y,m),e=Math.max(e,m),n<=e)break}return y}else{let y=1/0;for(const u of M){const i=h(o,u,t,f);let m;if(u.type==="jump"){const c=i.find(p=>p.id===u.pieceId),j=P(c.player,f,t);c&&!c.isKing&&j.includes(String(u.target))?m=x(i,r-1,e,n,!0,t,s,f):c&&E(c,i,t,s,f).filter(K=>K.type==="jump").length>0?m=x(i,r,e,n,!1,t,s,f):m=x(i,r-1,e,n,!0,t,s,f)}else m=x(i,r-1,e,n,!0,t,s,f);if(y=Math.min(y,m),n=Math.min(n,m),n<=e)break}return y}};self.onmessage=o=>{const{pieces:r,activeNodes:e,adjacency:n,boardLayout:l,difficulty:t}=o.data,s=k(2,r,e,n,l);if(s.length===0){self.postMessage(null);return}if(t==="easy"){const u=s[Math.floor(Math.random()*s.length)];self.postMessage(u);return}const f=t==="hard"?6:2;let g=null,M=-1/0;const y=s.sort(()=>.5-Math.random());y.sort((u,i)=>u.type==="jump"&&i.type!=="jump"?-1:0);for(const u of y){const i=h(r,u,e,l),m=x(i,f-1,-1/0,1/0,!1,e,n,l);m>M&&(M=m,g=u)}self.postMessage(g)}})();
